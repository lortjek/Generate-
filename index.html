<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Promotion Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .aspect-9-16 {
            padding-bottom: 177.77%; /* 16 / 9 * 100 */
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d3748;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen custom-scrollbar">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
                AI Promotion Pro
            </h1>
            <p class="text-gray-300 mt-2">Unggah gambar, deskripsikan produk Anda, dan biarkan AI berkreasi.</p>
        </header>

        <main>
            <!-- Image Upload Section -->
            <div id="upload-section" class="w-full max-w-2xl mx-auto glassmorphism rounded-2xl p-6 md:p-8 text-center border-dashed border-2 border-gray-500 hover:border-blue-400 transition-all duration-300 cursor-pointer">
                <input type="file" id="image-uploader" class="hidden" accept="image/*">
                <div id="upload-prompt">
                    <i class="fas fa-cloud-upload-alt text-5xl text-blue-400"></i>
                    <p class="mt-4 text-lg font-semibold">1. Klik atau jatuhkan gambar di sini</p>
                    <p class="text-sm text-gray-400">PNG, JPG, atau WEBP.</p>
                </div>
                <div id="image-preview-container" class="hidden relative w-full max-w-sm mx-auto">
                    <img id="image-preview" src="#" alt="Pratinjau Gambar" class="rounded-xl max-h-64 mx-auto">
                    <button id="remove-image-btn" class="absolute -top-3 -right-3 bg-red-600 hover:bg-red-700 text-white rounded-full h-8 w-8 flex items-center justify-center transition-transform duration-200 hover:scale-110">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Product Description Section -->
            <div id="description-section" class="w-full max-w-2xl mx-auto mt-6">
                <label for="product-description" class="block mb-2 text-lg font-semibold text-center text-gray-300">2. Jelaskan Produk Anda (Opsional)</label>
                <textarea id="product-description" rows="4" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-4 text-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 custom-scrollbar" placeholder="Contoh: Ini adalah 'Kitty Mom', krim perawatan kulit untuk ibu, terbuat dari bahan alami, membantu melembutkan dan mencerahkan kulit. Target audiens adalah ibu muda usia 25-40 tahun."></textarea>
            </div>

            <div class="text-center mt-8">
                <button id="generate-btn" class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-3 px-8 rounded-full text-lg transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:scale-100" disabled>
                    <i class="fas fa-sparkles mr-2"></i> Buat Promosi
                </button>
            </div>

            <!-- Loading Section -->
            <div id="loading-section" class="hidden text-center my-12">
                <div class="loader mx-auto"></div>
                <p id="loading-text" class="mt-4 text-gray-300 text-lg">Menganalisis gambar dan deskripsi Anda...</p>
            </div>

             <!-- Error Message -->
            <div id="error-message" class="hidden text-center my-8 bg-red-900 border border-red-500 p-4 rounded-lg max-w-3xl mx-auto">
                <h3 class="font-bold text-red-300">Terjadi Kesalahan</h3>
                <p id="error-text" class="text-red-400 mt-2"></p>
            </div>

            <!-- Results Section -->
            <div id="results-section" class="hidden mt-12">
                <h2 class="text-3xl font-bold text-center mb-8">Hasil Promosi Anda</h2>
                <div id="results-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                    <!-- Result cards will be injected here by JavaScript -->
                </div>
            </div>
        </main>
    </div>

    <!-- Template for Result Card -->
    <template id="result-card-template">
        <div class="result-card glassmorphism rounded-2xl overflow-hidden flex flex-col h-full">
            <div class="relative aspect-9-16 w-full bg-gray-800">
                <img class="generated-image absolute top-0 left-0 w-full h-full object-cover" src="https://placehold.co/360x640/1a202c/ffffff?text=Generating..." alt="Gambar Promosi">
                <div class="image-loader absolute inset-0 flex items-center justify-center bg-black bg-opacity-50">
                     <div class="loader"></div>
                </div>
            </div>
            <div class="p-4 flex flex-col flex-grow">
                 <!-- Image Prompt -->
                <div class="mb-4">
                    <label class="text-sm font-bold text-blue-300 block mb-1">Prompt Gambar:</label>
                    <textarea class="image-prompt-input w-full bg-gray-800 border border-gray-700 rounded-lg p-2 text-xs text-gray-300 h-24 custom-scrollbar focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                
                 <!-- Image Action Buttons -->
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button class="regenerate-image-btn bg-gray-700 hover:bg-gray-600 text-white py-2 px-3 rounded-lg text-xs transition-colors duration-200 flex items-center justify-center">
                        <i class="fas fa-sync-alt mr-1"></i> Generate Ulang
                    </button>
                    <a href="#" download="promosi.png" class="download-image-btn bg-green-600 hover:bg-green-700 text-white py-2 px-3 rounded-lg text-xs transition-colors duration-200 flex items-center justify-center pointer-events-none opacity-50">
                        <i class="fas fa-download mr-1"></i> Download
                    </a>
                </div>

                 <!-- Video Prompt -->
                <div class="mt-auto pt-4 border-t border-gray-700">
                    <label class="text-sm font-bold text-purple-300 block mb-2">Ide Konten Video (8 detik):</label>
                    <div class="video-prompt-output text-xs p-3 bg-gray-800 rounded-lg text-gray-300 custom-scrollbar h-32 overflow-y-auto"></div>
                    <button class="copy-video-prompt-btn bg-purple-600 hover:bg-purple-700 text-white py-2 px-3 rounded-lg text-xs transition-colors duration-200 w-full mt-2 flex items-center justify-center">
                        <i class="fas fa-copy mr-1"></i> Salin Prompt Video
                    </button>
                </div>
            </div>
        </div>
    </template>
    
    <script>
        // --- Global Configuration & Variables ---
        const imageUploader = document.getElementById('image-uploader');
        const uploadSection = document.getElementById('upload-section');
        const uploadPrompt = document.getElementById('upload-prompt');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const removeImageBtn = document.getElementById('remove-image-btn');
        const generateBtn = document.getElementById('generate-btn');
        const loadingSection = document.getElementById('loading-section');
        const loadingText = document.getElementById('loading-text');
        const resultsSection = document.getElementById('results-section');
        const resultsGrid = document.getElementById('results-grid');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        // NEW: Get the description input
        const productDescription = document.getElementById('product-description');

        let uploadedImageBase64 = null;
        
        // --- API Configuration ---
        const apiKey = ""; 
        const genAIApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const imageGenApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

        // --- Event Listeners ---
        uploadSection.addEventListener('click', () => imageUploader.click());
        uploadSection.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); uploadSection.classList.add('border-blue-400'); });
        uploadSection.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); uploadSection.classList.remove('border-blue-400'); });
        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault(); e.stopPropagation();
            uploadSection.classList.remove('border-blue-400');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFile(files[0]);
        });

        imageUploader.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFile(e.target.files[0]); });
        removeImageBtn.addEventListener('click', (e) => { e.stopPropagation(); resetUpload(); });
        generateBtn.addEventListener('click', handleGenerationProcess);

        // --- Main Functions ---
        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showError("File yang diunggah harus berupa gambar.");
                return;
            }
            const reader = new FileReader();
            reader.onloadend = () => {
                uploadedImageBase64 = reader.result.split(',')[1];
                imagePreview.src = reader.result;
                uploadPrompt.classList.add('hidden');
                imagePreviewContainer.classList.remove('hidden');
                generateBtn.disabled = false;
            };
            reader.readAsDataURL(file);
        }

        function resetUpload() {
            imageUploader.value = '';
            uploadedImageBase64 = null;
            imagePreview.src = '#';
            uploadPrompt.classList.remove('hidden');
            imagePreviewContainer.classList.add('hidden');
            generateBtn.disabled = true;
            resultsSection.classList.add('hidden');
            resultsGrid.innerHTML = '';
            productDescription.value = ''; // Clear description field too
            hideError();
        }

        async function handleGenerationProcess() {
            if (!uploadedImageBase64) {
                showError("Mohon unggah gambar terlebih dahulu.");
                return;
            }
            
            setLoadingState(true, "Menganalisis gambar dan deskripsi Anda...");
            resultsGrid.innerHTML = '';
            resultsSection.classList.remove('hidden');
            populateInitialCards();
            hideError();

            // NEW: Get the description value from the textarea
            const userDescription = productDescription.value.trim();

            try {
                // Step 1: Analyze image, now with user description
                const analysisPayload = {
                    contents: [{
                        parts: [{ text: `
                            You are a world-class professional promotion and marketing expert. Analyze this product image AND the user's description below. This description is the primary source of truth.

                            ---
                            **User's Product Description:**
                            ${userDescription || "Tidak ada deskripsi yang diberikan. Analisis hanya dari gambar."}
                            ---

                            Your main task is to create promotional concepts that use the product from the image as a reference, placing it into a new scene.
                            **CRITICAL RULE: DO NOT change the product itself.** The generated image must show the exact same product, but in a new, professional environment that reflects the user's description.
                            
                            Create a JSON object with a single key: "promotions". The value must be an array of 5 different promotion concepts.
                            Each object in the array must have two keys: "image_prompt" and "video_prompt".

                            - "image_prompt": Based on the user's description, create a detailed prompt for an image generation AI to create a 9:16 promotional photo. Describe a NEW scene, background, lighting, and mood that aligns with the product's purpose and target audience from the description.
                              **If the concept involves a person, you MUST describe them as 'a fair-skinned Indonesian woman' or 'a fair-skinned Indonesian man'.**
                              Example: 'The user's product, a beautiful ceramic mug, sits on a rustic wooden table. Beside it is a laptop and a notebook. A fair-skinned Indonesian woman's hands are typing on the laptop. Morning light from a window illuminates the scene. Professional photo, hyper-detailed, 9:16 aspect ratio.'

                            - "video_prompt": Create a detailed prompt for a video AI for an 8-second, 9:16 video. The scene must also feature the original product. If a person is present, they must be Indonesian with fair skin. Format as a JSON object with "scene_description" and "narasi" keys.
                              Example:
                              {"scene_description": "A slow pan across a modern kitchen counter, revealing the user's product prominently displayed. A fair-skinned Indonesian man smiles as he places a cup under the machine. Cinematic, warm lighting.", "narasi": "(Suara yang ramah dan hangat) 'Mulailah hari Anda dengan sempurna. Kualitas terbaik, hanya untuk Anda.'"}
                            
                            Ensure the entire output is a single, valid JSON object.
                            `},
                            { inlineData: { mimeType: "image/jpeg", data: uploadedImageBase64 } }
                        ]
                    }],
                     generationConfig: { responseMimeType: "application/json" }
                };
                
                const analysisResponse = await makeApiCall(genAIApiUrl, analysisPayload);
                if (!analysisResponse.promotions || analysisResponse.promotions.length === 0) {
                     throw new Error("AI tidak dapat menghasilkan prompt. Coba gambar lain atau tambahkan deskripsi.");
                }

                // Step 2: Generate each image from the prompts
                setLoadingState(true, "Membuat gambar promosi (1 dari 5)...");
                const promotionConcepts = analysisResponse.promotions;

                const imageGenerationPromises = promotionConcepts.map((concept, index) => {
                    return (async () => {
                        const card = resultsGrid.children[index];
                        if (!card) return;
                        card.querySelector('.image-prompt-input').value = concept.image_prompt;
                        card.querySelector('.video-prompt-output').innerHTML = `<strong>Deskripsi Adegan:</strong><br>${concept.video_prompt.scene_description}<br><br><strong>Narasi:</strong><br><em>"${concept.video_prompt.narasi}"</em>`;
                        
                        try {
                            const imageData = await generateImage(concept.image_prompt);
                            updateCardWithImage(card, imageData);
                        } catch (imgError) {
                            console.error(`Error generating image ${index + 1}:`, imgError);
                            updateCardWithError(card, `Gagal membuat gambar.`);
                        }
                        if (index < 4) {
                           loadingText.textContent = `Membuat gambar promosi (${index + 2} dari 5)...`;
                        }
                    })();
                });

                await Promise.all(imageGenerationPromises);

            } catch (error) {
                console.error("Error during generation process:", error);
                showError(error.message || "Terjadi kesalahan yang tidak diketahui. Silakan coba lagi.");
                resultsSection.classList.add('hidden');
            } finally {
                setLoadingState(false);
            }
        }

        async function generateImage(prompt) {
             const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } };
             const response = await makeApiCall(imageGenApiUrl, payload, true);
             if (response.predictions && response.predictions.length > 0 && response.predictions[0].bytesBase64Encoded) {
                 return `data:image/png;base64,${response.predictions[0].bytesBase64Encoded}`;
             } else {
                  throw new Error("Format respons gambar dari API tidak valid.");
             }
        }

        async function makeApiCall(url, payload, isPredict = false) {
             let lastError = null;
             for (let i = 0; i < 3; i++) {
                 try {
                     const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                     if (!response.ok) {
                         const errorBody = await response.json();
                         throw new Error(`Gagal menghubungi AI: ${errorBody.error?.message || response.statusText}`);
                     }
                     const result = await response.json();
                     if (isPredict) return result;
                     const textContent = result.candidates?.[0]?.content?.parts?.[0]?.text;
                     if(!textContent) throw new Error("Respons AI tidak berisi teks yang valid.");
                     try {
                         const cleanedText = textContent.replace(/```json/g, '').replace(/```/g, '').trim();
                         return JSON.parse(cleanedText);
                     } catch (e) { throw new Error("AI memberikan respons dalam format yang tidak terduga."); }
                 } catch (error) {
                     lastError = error;
                     await new Promise(resolve => setTimeout(resolve, i * 1000));
                 }
             }
             throw lastError; // Rethrow the last error if all retries fail
        }

        function setLoadingState(isLoading, text = '') {
            if (isLoading) {
                loadingSection.classList.remove('hidden');
                loadingText.textContent = text;
                generateBtn.disabled = true;
                generateBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Mohon Tunggu...`;
            } else {
                loadingSection.classList.add('hidden');
                generateBtn.disabled = false;
                 generateBtn.innerHTML = `<i class="fas fa-sparkles mr-2"></i> Buat Promosi`;
            }
        }

        function showError(message) {
            errorMessage.classList.remove('hidden');
            errorText.textContent = message;
        }

        function hideError() {
            errorMessage.classList.add('hidden');
        }

        function populateInitialCards() {
            const template = document.getElementById('result-card-template');
            for (let i = 0; i < 5; i++) {
                const clone = template.content.cloneNode(true);
                resultsGrid.appendChild(clone);
            }
        }
        
        function updateCardWithImage(card, imageData) {
            const img = card.querySelector('.generated-image');
            const loader = card.querySelector('.image-loader');
            const downloadBtn = card.querySelector('.download-image-btn');
            
            img.src = imageData;
            img.onload = () => {
                loader.classList.add('hidden');
                downloadBtn.href = imageData;
                downloadBtn.classList.remove('pointer-events-none', 'opacity-50');
            };
        }

        function updateCardWithError(card, message) {
            const img = card.querySelector('.generated-image');
            const loader = card.querySelector('.image-loader');
            img.src = `https://placehold.co/360x640/1a202c/e53e3e?text=${encodeURIComponent(message)}`;
            loader.classList.add('hidden');
        }
        
        // --- Delegated Event Listeners for Dynamic Content ---
        resultsGrid.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const card = target.closest('.result-card');
            if (!card) return;

            if (target.matches('.regenerate-image-btn')) {
                const promptInput = card.querySelector('.image-prompt-input');
                const newPrompt = promptInput.value;
                
                card.querySelector('.image-loader').classList.remove('hidden');
                card.querySelector('.generated-image').src = 'https://placehold.co/360x640/1a202c/ffffff?text=Generating...';
                card.querySelector('.download-image-btn').classList.add('pointer-events-none', 'opacity-50');

                try {
                    const imageData = await generateImage(newPrompt);
                    updateCardWithImage(card, imageData);
                } catch (error) {
                    console.error("Error regenerating image:", error);
                    updateCardWithError(card, 'Gagal generate ulang.');
                }
            } else if (target.matches('.copy-video-prompt-btn')) {
                 const videoPromptDiv = card.querySelector('.video-prompt-output');
                 // Create a temporary textarea to copy the text
                 const tempTextArea = document.createElement('textarea');
                 tempTextArea.value = videoPromptDiv.innerText; // Use innerText to get formatted text
                 document.body.appendChild(tempTextArea);
                 tempTextArea.select();
                 document.execCommand('copy');
                 document.body.removeChild(tempTextArea);

                 // Provide feedback
                 const originalText = target.innerHTML;
                 target.innerHTML = `<i class="fas fa-check mr-1"></i> Disalin!`;
                 setTimeout(() => {
                     target.innerHTML = originalText;
                 }, 2000);
            }
        });
    </script>
</body>
</html>

