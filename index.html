<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Generator Promosi Produk (Mode Analisis Teks)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Konfigurasi Font Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            min-height: 100vh; 
        }
        .loading-dot {
            animation: pulse 1.5s infinite ease-in-out;
            background-color: #ffffff;
            border-radius: 50%;
            height: 10px;
            width: 10px;
            margin: 0 4px;
        }
        .loading-dot:nth-child(1) { animation-delay: 0.0s; }
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes pulse {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        .video-loading-dot {
            background-color: #6366f1; /* Indigo */
        }
    </style>
    <!-- Firebase SDK Imports (Minimal for Auth and Firestore boilerplate) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;

        if (firebaseConfig) {
            try {
                setLogLevel('error');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = `ID Pengguna: ${userId}`;
                    } else {
                        const signIn = async () => {
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            } catch (error) {
                                console.error("Firebase Auth Error:", error);
                            }
                        };
                        signIn();
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
            }
        }
    </script>
</head>
<body class="p-4">

    <main class="max-w-xl mx-auto">
        <h1 class="text-2xl font-bold text-gray-800 mb-4 text-center">✅ AI Generator Promosi (Mode Teks Stabil)</h1>
        <p id="user-id-display" class="text-xs text-center text-gray-500 mb-6"></p>

        <section class="bg-white p-5 rounded-xl shadow-2xl border border-gray-100">
            <h2 class="text-xl font-semibold text-indigo-700 mb-3 border-b pb-2">🧠 1. Analisis Produk & Saran Pose</h2>
            <p class="text-sm text-gray-600 mb-4">Aplikasi ini sekarang fokus memberikan **6 ide pose foto/video** dan **konsep gerakan Veo 3** yang dijamin berhasil, karena fungsi generate gambar yang tidak stabil telah dihapus.</p>
            
            <!-- Input Produk -->
            <div class="mb-5 space-y-4">
                <div>
                    <label for="productImage" class="block text-sm font-medium text-gray-700 mb-1">Unggah Foto Produk Anda (Wajib):</label>
                    <input type="file" id="productImage" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-3 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition duration-150 rounded-lg border border-gray-300 p-2">
                </div>
                <div>
                    <label for="productDesc" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi Produk (Opsional, untuk konteks):</label>
                    <input type="text" id="productDesc" placeholder="Contoh: Serum wajah dengan Niacinamide, efektif mencerahkan kulit kusam dan aman untuk kulit sensitif." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <button id="btnSuggestPrompts" onclick="suggestPrompts()" class="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-150 transform hover:scale-[1.01] flex items-center justify-center" disabled>
                    <span id="suggestText">Analis 6 Pose & Konsep Video Otomatis</span>
                    <div id="suggestLoading" class="hidden flex items-center ml-2">
                        <div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div>
                    </div>
                </button>
                <p id="imageError" class="text-sm text-red-600 hidden mt-2">Mohon unggah foto produk.</p>
            </div>
            
            <!-- Hasil Saran Pose & Konsep Video -->
            <h3 class="text-lg font-semibold text-gray-800 mb-4 mt-8">6 Hasil Analisis & Konsep Promosi (Teks)</h3>
            <div id="promptSuggestions" class="space-y-6">
                <!-- Suggestion cards will be inserted here -->
            </div>
            
            <p id="promptStatus" class="text-center text-sm text-gray-500 mt-4 hidden">Unggah produk Anda untuk memulai proses analisis.</p>
        </section>

    </main>

    <script>
        // --- Konfigurasi API ---
        const API_KEY = "AIzaSyA2tl1iJme_mqCFjtlUzx9VypmeQ-YGn7g"; 
        const GEMINI_API_URL_TEXT = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;

        // --- Variabel Global dan State ---
        let base64Image = null;
        let base64MimeType = null;
        let prompts = [];
        
        // --- Referensi DOM ---
        const imageInput = document.getElementById('productImage');
        const productDescInput = document.getElementById('productDesc');
        const btnSuggest = document.getElementById('btnSuggestPrompts');
        const suggestLoading = document.getElementById('suggestLoading');
        const suggestText = document.getElementById('suggestText');
        const promptSuggestionsDiv = document.getElementById('promptSuggestions');
        const promptStatus = document.getElementById('promptStatus');
        const imageError = document.getElementById('imageError');
        
        // --- Utility: Exponential Backoff (MANDATORY) ---
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000); 

                    const response = await fetch(url, { ...options, signal: controller.signal });
                    clearTimeout(timeoutId);

                    if (response.status === 429 || response.status >= 500) {
                        console.warn(`[Retry] Status ${response.status}. Retrying in ${2 ** i}s...`);
                    } else {
                        return response;
                    }
                } catch (error) {
                    if (error.name === 'AbortError') {
                        throw new Error("Permintaan waktu habis (timeout) setelah 30 detik.");
                    }
                    console.warn(`[Retry] Fetch error. Retrying in ${2 ** i}s...`, error);
                }
                await new Promise(resolve => setTimeout(resolve, 2 ** i * 1000));
            }
            throw new Error("Permintaan API gagal setelah beberapa kali percobaan.");
        }

        // --- 1. Logika Unggah Gambar ---
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            imageError.classList.add('hidden'); 
            
            if (!file) {
                base64Image = null;
                base64MimeType = null;
                btnSuggest.disabled = true;
                return;
            }
            
            if (file.size > 4 * 1024 * 1024) {
                 imageError.textContent = "Ukuran gambar terlalu besar (Maks 4MB).";
                 imageError.classList.remove('hidden');
                 btnSuggest.disabled = true;
                 return;
            }

            const reader = new FileReader();
            reader.onload = () => {
                const parts = reader.result.split(',');
                if (parts.length < 2) {
                    imageError.textContent = "Gagal memproses file gambar. Format tidak valid.";
                    imageError.classList.remove('hidden');
                    btnSuggest.disabled = true;
                    return;
                }
                
                base64MimeType = parts[0].split(';')[0].split(':')[1];
                base64Image = parts[1];
                
                btnSuggest.disabled = false;
                promptStatus.textContent = "Tekan tombol untuk menganalisis dan menghasilkan 6 konsep.";
                promptStatus.classList.remove('hidden');
            };
            reader.onerror = (error) => {
                console.error("FileReader Error:", error);
                imageError.textContent = "Gagal membaca file gambar. Coba format lain (PNG/JPG).";
                imageError.classList.remove('hidden');
                btnSuggest.disabled = true;
            };
            reader.readAsDataURL(file);
        });

        // --- 2. Logika Saran Prompt AI (Gemini Multimodal - HANYA ANALISIS) ---
        async function suggestPrompts() {
            if (!base64Image) {
                imageError.textContent = "Mohon unggah foto produk terlebih dahulu.";
                imageError.classList.remove('hidden');
                return;
            }

            // UI Loading State START
            btnSuggest.disabled = true;
            suggestText.textContent = "Menganalisis Gambar Produk & Membuat Konsep...";
            suggestLoading.classList.remove('hidden');
            promptSuggestionsDiv.innerHTML = '';
            promptStatus.textContent = "AI sedang membuat 6 ide pose dan konsep video. Mohon tunggu 30-60 detik...";
            promptStatus.classList.remove('hidden');

            const productDesc = productDescInput.value || "Tidak ada deskripsi tambahan.";
            
            // PROMPT GEMINI UNTUK IDE POSE: Menggunakan "Model Indonesia" tanpa detail usia/warna kulit
            const userQuery = `Berdasarkan gambar produk dan deskripsi: "${productDesc}", berikan 6 ide skenario/gaya foto promosi yang sangat menarik, detail, dan realistis untuk rasio 9:16 (portrait/vertical). Jika skenario melibatkan orang, gunakan kata: "pria atau wanita model Indonesia". Berikan setiap saran dalam satu kalimat deskriptif yang bagus, fokus pada pencahayaan, latar belakang, dan komposisi yang menonjolkan produk.`;

            const systemPrompt = "Anda adalah ahli pemasaran produk dan fotografer profesional. Anda harus menghasilkan 6 prompt yang detail, masing-masing dalam satu kalimat, untuk model generasi gambar AI. Pastikan setiap prompt menghasilkan gambar realistis. Format output sebagai JSON array of strings.";

            const payload = {
                contents: [{
                    parts: [
                        { text: userQuery },
                        {
                            inlineData: {
                                mimeType: base64MimeType,
                                data: base64Image
                            }
                        }
                    ]
                }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: { type: "STRING" }
                    }
                }
            };

            try {
                const response = await fetchWithRetry(GEMINI_API_URL_TEXT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorResponseText = await response.text();
                    console.error(`Gemini API Error: Status ${response.status}. Pesan: ${errorResponseText}`);
                    throw new Error(`Gagal (Kode ${response.status}).`);
                }

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (jsonText) {
                    try {
                        const rawPrompts = JSON.parse(jsonText);
                        prompts = rawPrompts
                            .filter(p => typeof p === 'string' && p.trim().length > 0)
                            .slice(0, 6);
                        
                        if (prompts.length === 0) {
                            throw new Error("AI tidak menghasilkan saran prompt yang valid (0 prompt).");
                        }

                        // HANYA RENDER CARD, TIDAK ADA GENERATE GAMBAR
                        renderPromptSuggestions();
                        await generateAllVideoConcepts(prompts); 

                    } catch (e) {
                        console.error("Gagal memproses JSON dari AI:", e);
                        throw new Error(`Gagal memproses respons AI. (${e.message})`);
                    }
                } else {
                    throw new Error("Tidak ada respons konten yang diterima dari AI.");
                }

            } catch (error) {
                // UI Loading State FAILURE
                console.error("Error saat meminta saran prompt:", error);
                promptStatus.textContent = `🚨 ERROR KRITIS: Gagal menganalisis produk. (${error.message})`;
                prompts = [];
            } finally {
                btnSuggest.disabled = false;
                suggestText.textContent = "Analis 6 Pose & Konsep Video Otomatis";
                suggestLoading.classList.add('hidden');
            }
        }

        // --- 3. Rendering Cards and Start Generation Loop ---
        function renderPromptSuggestions() {
            promptSuggestionsDiv.innerHTML = '';
            prompts.forEach((prompt, index) => {
                const card = document.createElement('div');
                card.id = `prompt-card-${index}`;
                card.className = 'bg-white p-4 rounded-xl shadow-lg flex flex-col space-y-3 border border-gray-200';
                card.innerHTML = `
                    <p class="text-xs font-semibold text-indigo-600">Pose #${index + 1} | Subjek: Model Indonesia</p>
                    <p id="prompt-text-${index}" class="text-sm text-gray-700">${prompt}</p>
                    
                    <!-- Area Teks Pengganti Gambar -->
                    <div class="p-3 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                        <p class="text-xs text-gray-500 font-semibold">Teks ini adalah *prompt* Anda (9:16) yang siap digunakan di AI Generate Gambar/Video.</p>
                    </div>

                    
                    <div class="flex space-x-2 mt-2">
                        <button onclick="copyPromptText(${index})" class="flex-1 px-4 py-2 text-xs bg-yellow-500 text-white font-semibold rounded-xl hover:bg-yellow-600 transition duration-150 transform hover:scale-[1.03]">
                            📝 Salin Prompt Foto
                        </button>
                    </div>

                    <!-- Video Concept Area -->
                    <div id="video-concept-container-${index}" class="mt-4 p-3 bg-indigo-50 rounded-xl border border-indigo-200">
                        <h4 class="text-sm font-bold text-indigo-700 mb-2 flex items-center">
                            🎬 Konsep Video 8 Detik (Veo 3 Style)
                        </h4>
                        <div id="video-content-${index}" class="text-xs text-gray-700 leading-relaxed">
                            <span class="flex items-center">
                                Memulai generate konsep video...
                                <span id="video-loading-${index}" class="flex items-center ml-2">
                                    <div class="loading-dot video-loading-dot"></div><div class="loading-dot video-loading-dot"></div><div class="loading-dot video-loading-dot"></div>
                                </span>
                            </span>
                        </div>
                        
                        <!-- NEW SECTION FOR SINGLE VEO PROMPT -->
                        <div class="mt-4 pt-3 border-t border-indigo-300">
                            <button onclick="requestVeoPrompt(${index})" id="btn-veo-prompt-${index}" class="w-full px-4 py-2 text-xs font-semibold bg-pink-600 text-white rounded-xl hover:bg-pink-700 transition duration-150" disabled>
                                ✨ Konversi ke Prompt Video (Siap Copy)
                            </button>
                            <div id="veo-prompt-output-${index}" class="mt-2 p-3 bg-indigo-100 rounded-lg text-xs hidden cursor-pointer hover:bg-indigo-200 transition duration-150" onclick="copyToClipboard('veo-prompt-content-${index}')">
                                <p class="text-pink-800 font-bold mb-1">Prompt Veo 3 Final (Klik untuk Salin):</p>
                                <code id="veo-prompt-content-${index}" class="block text-gray-800 whitespace-pre-wrap"></code>
                            </div>
                        </div>
                    </div>
                `;
                promptSuggestionsDiv.appendChild(card);
            });
        }
        
        async function generateAllVideoConcepts(prompts) {
            promptStatus.textContent = `Analisis selesai! Sekarang membuat 6 konsep video Veo 3.`;
            
            for (let i = 0; i < prompts.length; i++) {
                await generateVideoConceptForPrompt(i, prompts[i]);
            }
            
            // Final UI Reset State
            btnSuggest.disabled = false;
            suggestText.textContent = "Analis 6 Pose & Konsep Video Otomatis";
            suggestLoading.classList.add('hidden');
            promptStatus.textContent = "Proses 6 konsep promosi telah selesai! Salin prompt dan gunakan di generator AI pilihan Anda.";
        }

        // --- 4. Logika Salin Prompt Foto ---
        function copyPromptText(index) {
            const promptText = document.getElementById(`prompt-text-${index}`).textContent;
            const textarea = document.createElement('textarea');
            textarea.value = promptText;
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                const btn = document.querySelector(`.space-x-2 button:nth-child(1)`);
                const originalText = btn.textContent;
                btn.textContent = "TEKS TERSALIN!";
                setTimeout(() => btn.textContent = originalText, 1000);
            } catch (err) {
                console.error('Gagal menyalin:', err);
            }
            document.body.removeChild(textarea);
        }


        // --- 5. Logika Perencana Video Promosi (Gemini Text per Pose) ---
        async function generateVideoConceptForPrompt(index, prompt) {
            const videoContentDiv = document.getElementById(`video-content-${index}`);
            const videoLoadingSpan = document.getElementById(`video-loading-${index}`);
            const veoPromptButton = document.getElementById(`btn-veo-prompt-${index}`);
            
            // UI Loading State
            videoContentDiv.innerHTML = 'AI sedang menulis skrip gerakan...';
            videoLoadingSpan.classList.remove('hidden');
            veoPromptButton.disabled = true;

            // Prompt Gemini untuk Video
            const userQuery = `Produk/Konsep: ${prompt}. Buat skrip gerakan dan adegan yang sangat detail (sekitar 8 detik) untuk video promosi vertikal 9:16 (Veo 3 style), fokus pada gerakan kamera sinematik dan transisi cepat. Gunakan "Model Asia Tenggara" sebagai subjek.`;

            const systemPrompt = "Anda adalah sutradara video AI Veo 3. Buatlah konsep skrip gerakan P.O.V. (Point of View) yang sangat rinci dan deskriptif, dipecah menjadi 3-4 bidikan (shots) yang sinematik (total 8 detik). Setiap bidikan harus menjelaskan: Gerakan Kamera, Latar Belakang/Lokasi, dan Aksi Produk/Model. Format output dalam Markdown yang rapi dengan heading dan poin-poin.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithRetry(GEMINI_API_URL_TEXT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Gemini API Error: Status ${response.status}`);
                }
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    let htmlContent = text.replace(/##\s*/g, '<strong>').replace(/\n/g, '<br>').replace(/\*\*/g, '</strong>');
                    videoContentDiv.innerHTML = htmlContent;
                    veoPromptButton.disabled = false; 
                } else {
                    videoContentDiv.innerHTML = '<p class="text-red-500">Gagal generate konsep video.</p>';
                }

            } catch (error) {
                console.error("Error saat generate konsep video:", error);
                videoContentDiv.innerHTML = `<p class="text-red-500">Error koneksi/API. Gagal generate konsep video. (${error.message})</p>`;
            } finally {
                videoLoadingSpan.classList.add('hidden');
            }
        }
        
        // --- 6. Logika Konversi ke Single Veo Prompt ---
        async function requestVeoPrompt(index) {
            const btnVeo = document.getElementById(`btn-veo-prompt-${index}`);
            const videoContentDiv = document.getElementById(`video-content-${index}`);
            const veoOutputDiv = document.getElementById(`veo-prompt-output-${index}`);
            const veoContentCode = document.getElementById(`veo-prompt-content-${index}`);
            
            const detailedConcept = videoContentDiv.innerText;

            if (!detailedConcept || detailedConcept.includes('Memulai generate konsep video') || detailedConcept.includes('Gagal')) {
                btnVeo.textContent = "KONSEP BELUM SIAP!";
                setTimeout(() => btnVeo.textContent = "✨ Konversi ke Prompt Video (Siap Copy)", 2000);
                return;
            }

            // UI Loading State
            btnVeo.disabled = true;
            const originalText = btnVeo.textContent;
            btnVeo.textContent = "Mengkonversi ke Prompt Tunggal...";
            veoOutputDiv.classList.add('hidden');

            const userQuery = `Sintesiskan konsep video berikut menjadi SATU prompt tunggal yang sangat deskriptif dan padat (maksimal 2 kalimat) untuk model text-to-video AI seperti Veo 3. Pertahankan detail gerakan kamera, fokus, dan aksi model/produk. Konsep: ${detailedConcept}`;

            const systemPrompt = "Anda adalah prompt engineer video AI. Tugas Anda adalah mengubah skrip terperinci menjadi satu prompt tunggal yang powerful, siap pakai, dan sinematik. Jawab hanya dengan prompt tunggal tersebut, tanpa teks pengantar atau penutup. Tambahkan kata kunci sinematik dan resolusi 9:16.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithRetry(GEMINI_API_URL_TEXT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Gemini API Error: Status ${response.status}`);
                }
                
                const result = await response.json();
                const singlePrompt = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (singlePrompt) {
                    veoContentCode.textContent = singlePrompt.trim();
                    veoOutputDiv.classList.remove('hidden');
                } else {
                    veoContentCode.textContent = 'Gagal membuat prompt tunggal. Coba Edit & Ulangi Konsep.';
                    veoOutputDiv.classList.remove('hidden');
                }

            } catch (error) {
                console.error("Error saat mengkonversi prompt Veo:", error);
                veoContentCode.textContent = `Error koneksi AI saat konversi prompt. (${error.message})`;
                veoOutputDiv.classList.remove('hidden');
            } finally {
                btnVeo.disabled = false;
                btnVeo.textContent = originalText;
            }
        }

        // --- Utility: Copy to Clipboard (Custom) ---
        function copyToClipboard(elementId) {
            const textToCopy = document.getElementById(elementId).textContent;
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                const container = document.getElementById('veo-prompt-output-' + elementId.split('-')[3]);
                const originalBg = container.style.backgroundColor;
                container.style.backgroundColor = '#d1e7dd'; 
                setTimeout(() => {
                    container.style.backgroundColor = originalBg;
                }, 1000);

            } catch (err) {
                console.error('Gagal menyalin:', err);
            }
            document.body.removeChild(textarea);
        }
    </script>

</body>
</html>

