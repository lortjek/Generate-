<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Generator Promosi Produk (Universal)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Konfigurasi Font Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            /* Pastikan body mengisi seluruh viewport di perangkat mobile */
            min-height: 100vh; 
        }
        .loading-dot {
            animation: pulse 1.5s infinite ease-in-out;
            background-color: #ffffff;
            border-radius: 50%;
            height: 10px;
            width: 10px;
            margin: 0 4px;
        }
        .loading-dot:nth-child(1) { animation-delay: 0.0s; }
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes pulse {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        .video-loading-dot {
            background-color: #6366f1; /* Indigo */
        }
        /* Style untuk container gambar 9:16 di mobile */
        .image-aspect-ratio {
            width: 100%;
            padding-bottom: 177.77%; /* 16:9 ratio (9/16 * 100) */
            position: relative;
        }
        .image-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
    <!-- Firebase SDK Imports (Minimal for Auth and Firestore boilerplate) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;

        if (firebaseConfig) {
            try {
                setLogLevel('error');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = `ID Pengguna: ${userId}`;
                    } else {
                        const signIn = async () => {
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            } catch (error) {
                                console.error("Firebase Auth Error:", error);
                            }
                        };
                        signIn();
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
            }
        }
    </script>
</head>
<body class="p-4">

    <main class="max-w-xl mx-auto">
        <h1 class="text-2xl font-bold text-gray-800 mb-4 text-center">üöÄ AI Promosi Universal (Mobile Ready)</h1>
        <p id="user-id-display" class="text-xs text-center text-gray-500 mb-6"></p>

        <!-- Bagian 1: Generator Gambar Promosi (9:16 Realistis) -->
        <section class="bg-white p-5 rounded-xl shadow-2xl border border-gray-100">
            <h2 class="text-xl font-semibold text-indigo-700 mb-3 border-b pb-2">üñºÔ∏è 1. Input Produk & Generate Otomatis</h2>
            
            <!-- Input Produk (Dibuat Stack Vertikal) -->
            <div class="mb-5 space-y-4">
                <div>
                    <label for="productImage" class="block text-sm font-medium text-gray-700 mb-1">Unggah Foto Produk Anda (Wajib):</label>
                    <input type="file" id="productImage" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-3 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition duration-150 rounded-lg border border-gray-300 p-2">
                </div>
                <div>
                    <label for="productDesc" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi Produk (Opsional, untuk konteks):</label>
                    <input type="text" id="productDesc" placeholder="Contoh: Serum wajah dengan Niacinamide, efektif mencerahkan kulit kusam dan aman untuk kulit sensitif." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <button id="btnSuggestPrompts" onclick="suggestPrompts()" class="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-150 transform hover:scale-[1.01] flex items-center justify-center" disabled>
                    <span id="suggestText">Analis & Generate 6 Pose Otomatis</span>
                    <div id="suggestLoading" class="hidden flex items-center ml-2">
                        <div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div>
                    </div>
                </button>
                <p id="imageError" class="text-sm text-red-600 hidden mt-2">Mohon unggah foto produk.</p>
            </div>
            
            <!-- Hasil Saran Pose & Gambar (Kolom Tunggal di Mobile) -->
            <h3 class="text-lg font-semibold text-gray-800 mb-4 mt-8">6 Hasil Generate Gambar Promosi (9:16)</h3>
            <div id="promptSuggestions" class="space-y-6">
                <!-- Suggestion cards will be inserted here -->
            </div>
            
            <p id="promptStatus" class="text-center text-sm text-gray-500 mt-4 hidden">Unggah produk Anda untuk memulai proses generate.</p>
        </section>

    </main>

    <!-- Modal Edit Prompt -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg">
            <h3 class="text-xl font-bold mb-4 text-indigo-700">Edit Prompt & Generate Ulang</h3>
            <textarea id="modalPromptInput" rows="5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4"></textarea>
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal()" class="px-5 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition duration-150">Batal</button>
                <button id="btnRegenerate" onclick="regenerateImage()" class="px-5 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition duration-150 transform hover:scale-[1.01]">Generate Gambar Baru</button>
            </div>
        </div>
    </div>

    <script>
        // --- Konfigurasi API ---
        const API_KEY = ""; // Kunci API akan disediakan oleh runtime
        const GEMINI_API_URL_TEXT = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const IMAGEN_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${API_KEY}`;

        // --- Variabel Global dan State ---
        let base64Image = null;
        let base64MimeType = null;
        let currentPromptIndex = null;
        let prompts = [];
        
        // --- Referensi DOM ---
        const imageInput = document.getElementById('productImage');
        const productDescInput = document.getElementById('productDesc');
        const btnSuggest = document.getElementById('btnSuggestPrompts');
        const suggestLoading = document.getElementById('suggestLoading');
        const suggestText = document.getElementById('suggestText');
        const promptSuggestionsDiv = document.getElementById('promptSuggestions');
        const promptStatus = document.getElementById('promptStatus');
        const imageError = document.getElementById('imageError');
        const editModal = document.getElementById('editModal');
        const modalPromptInput = document.getElementById('modalPromptInput');
        
        // --- Utility: Exponential Backoff (MANDATORY) ---
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    // Handle rate limiting (429) or server errors (5xx) by retrying
                    if (response.status === 429 || response.status >= 500) {
                        console.warn(`[Retry] Status ${response.status}. Retrying in ${2 ** i}s...`);
                    } else {
                        // For successful codes (2xx) or client errors (4xx) we return the response immediately
                        return response;
                    }
                } catch (error) {
                    // Network error, retry
                    console.warn(`[Retry] Fetch error. Retrying in ${2 ** i}s...`, error);
                }
                // Wait for exponential backoff time
                await new Promise(resolve => setTimeout(resolve, 2 ** i * 1000));
            }
            // If all retries fail, throw an error
            throw new Error("Permintaan API gagal setelah beberapa kali percobaan.");
        }

        // --- 1. Logika Unggah Gambar ---
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) {
                base64Image = null;
                base64MimeType = null;
                btnSuggest.disabled = true;
                return;
            }
            
            const reader = new FileReader();
            reader.onload = () => {
                const parts = reader.result.split(',');
                base64MimeType = parts[0].split(';')[0].split(':')[1];
                base64Image = parts[1];
                btnSuggest.disabled = false;
                imageError.classList.add('hidden');
                promptStatus.textContent = "Tekan tombol untuk memulai generate 6 pose otomatis.";
                promptStatus.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        });

        // --- 2. Logika Saran Prompt AI (Gemini Multimodal) ---
        async function suggestPrompts() {
            if (!base64Image) {
                imageError.textContent = "Mohon unggah foto produk terlebih dahulu.";
                imageError.classList.remove('hidden');
                return;
            }

            // UI Loading State START
            btnSuggest.disabled = true;
            suggestText.textContent = "Menganalisis Gambar Produk...";
            suggestLoading.classList.remove('hidden');
            promptSuggestionsDiv.innerHTML = '';
            promptStatus.textContent = "AI sedang membuat 6 ide pose dan akan memulai generate gambar. Mohon tunggu...";
            promptStatus.classList.remove('hidden');

            const productDesc = productDescInput.value || "Tidak ada deskripsi tambahan.";
            const userQuery = `Berdasarkan gambar produk dan deskripsi: "${productDesc}", berikan 6 ide skenario/gaya foto promosi yang sangat menarik, detail, dan realistis untuk rasio 9:16 (portrait/vertical). Jika skenario melibatkan orang, harus menampilkan subjek: pria atau wanita Indonesia usia 23 tahun berkulit putih. Berikan setiap saran dalam satu kalimat deskriptif yang bagus, fokus pada pencahayaan, latar belakang, dan komposisi yang menonjolkan produk.`;

            const systemPrompt = "Anda adalah ahli pemasaran produk dan fotografer profesional. Anda harus menghasilkan 6 prompt yang detail, masing-masing dalam satu kalimat, untuk model generasi gambar AI. Pastikan setiap prompt menghasilkan gambar realistis dengan fokus pada subjek (jika relevan) pria/wanita Indonesia, pencahayaan, dan komposisi 9:16 (vertical). Format output sebagai JSON array of strings.";

            const payload = {
                contents: [{
                    parts: [
                        { text: userQuery },
                        {
                            inlineData: {
                                mimeType: base64MimeType,
                                data: base64Image
                            }
                        }
                    ]
                }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: { type: "STRING" }
                    }
                }
            };

            try {
                const response = await fetchWithRetry(GEMINI_API_URL_TEXT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorResponseText = await response.text();
                    console.error(`Gemini API Error: Status ${response.status}. Pesan: ${errorResponseText}`);
                    throw new Error(`Gagal (Kode ${response.status}). Coba gambar lebih kecil.`);
                }

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (jsonText) {
                    try {
                        const rawPrompts = JSON.parse(jsonText);
                        prompts = rawPrompts
                            .filter(p => typeof p === 'string' && p.trim().length > 0)
                            .slice(0, 6);
                        
                        if (prompts.length === 0) {
                            throw new Error("AI tidak menghasilkan saran prompt yang valid (0 prompt).");
                        }

                        renderPromptSuggestions();
                        generateAllImagesAndVideos(prompts); // START AUTOMATIC GENERATION
                    } catch (e) {
                        console.error("Gagal memproses JSON dari AI:", e);
                        throw new Error(`Gagal memproses respons AI. Coba deskripsi yang lebih singkat. (${e.message})`);
                    }
                } else {
                    throw new Error("Tidak ada respons konten yang diterima dari AI.");
                }

            } catch (error) {
                // UI Loading State FAILURE
                console.error("Error saat meminta saran prompt:", error);
                promptStatus.textContent = `üö® ERROR KRITIS: Gagal menganalisis produk. Coba lagi, pastikan gambar di bawah 4MB, atau gunakan browser lain. (${error.message})`;
                prompts = [];
                btnSuggest.disabled = false;
                suggestText.textContent = "Analis & Generate 6 Pose Otomatis";
                suggestLoading.classList.add('hidden');
            }
        }

        // --- 3. Rendering Cards and Start Generation Loop ---
        function renderPromptSuggestions() {
            promptSuggestionsDiv.innerHTML = '';
            prompts.forEach((prompt, index) => {
                const card = document.createElement('div');
                card.id = `prompt-card-${index}`;
                card.className = 'bg-white p-4 rounded-xl shadow-lg flex flex-col space-y-3 border border-gray-200';
                card.innerHTML = `
                    <p class="text-xs font-semibold text-indigo-600">Pose #${index + 1} | Subjek: Pria/Wanita Indonesia (23, Kulit Putih)</p>
                    <p id="prompt-text-${index}" class="text-sm text-gray-700 h-12 overflow-hidden">${prompt}</p>
                    
                    <div class="image-aspect-ratio bg-gray-200 rounded-lg border border-dashed border-gray-400">
                        <div id="image-container-${index}" class="image-content flex items-center justify-center text-gray-500 text-center text-sm overflow-hidden">
                            Memulai Generate Gambar...
                        </div>
                    </div>

                    
                    <div class="flex space-x-2 mt-2">
                        <button onclick="openModal(${index})" class="flex-1 px-4 py-2 text-xs bg-yellow-500 text-white font-semibold rounded-xl hover:bg-yellow-600 transition duration-150 transform hover:scale-[1.03]">
                            üìù Edit
                        </button>
                        <button onclick="generateImage(${index}, true)" id="btn-generate-${index}" class="flex-1 px-4 py-2 text-xs bg-green-600 text-white font-semibold rounded-xl hover:bg-green-700 transition duration-150 transform hover:scale-[1.03]" disabled>
                            üöÄ Ulang
                        </button>
                        <button onclick="downloadImage(${index})" id="btn-download-${index}" class="flex-1 px-4 py-2 text-xs bg-indigo-500 text-white font-semibold rounded-xl hover:bg-indigo-600 transition duration-150 transform hover:scale-[1.03]" disabled>
                            ‚¨áÔ∏è Unduh
                        </button>
                    </div>

                    <!-- Video Concept Area -->
                    <div id="video-concept-container-${index}" class="mt-4 p-3 bg-indigo-50 rounded-xl border border-indigo-200">
                        <h4 class="text-sm font-bold text-indigo-700 mb-2 flex items-center">
                            üé¨ Konsep Video 8 Detik (Veo 3 Style)
                        </h4>
                        <div id="video-content-${index}" class="text-xs text-gray-700 leading-relaxed">
                            <span class="flex items-center">
                                Menunggu generate gambar selesai...
                                <span id="video-loading-${index}" class="flex items-center ml-2">
                                    <div class="loading-dot video-loading-dot"></div><div class="loading-dot video-loading-dot"></div><div class="loading-dot video-loading-dot"></div>
                                </span>
                            </span>
                        </div>
                        
                        <!-- NEW SECTION FOR SINGLE VEO PROMPT -->
                        <div class="mt-4 pt-3 border-t border-indigo-300">
                            <button onclick="requestVeoPrompt(${index})" id="btn-veo-prompt-${index}" class="w-full px-4 py-2 text-xs font-semibold bg-pink-600 text-white rounded-xl hover:bg-pink-700 transition duration-150" disabled>
                                ‚ú® Konversi ke Prompt Video (Siap Copy)
                            </button>
                            <div id="veo-prompt-output-${index}" class="mt-2 p-3 bg-indigo-100 rounded-lg text-xs hidden cursor-pointer hover:bg-indigo-200 transition duration-150" onclick="copyToClipboard('veo-